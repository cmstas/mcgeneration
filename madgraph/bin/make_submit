#!/usr/bin/env python3
# -*- coding: utf-8 -*

import os

GOOD_SITES = [
    "T2_US_Caltech",
    "T2_US_UCSD",
    "T2_US_Florida",
    "T2_US_MIT",
    "T2_US_Nebraska",
    "T2_US_Purdue",
    "T2_US_Vanderbilt",
    "T2_US_Wisconsin",
    # "T3_US_UCR",
    # "T3_US_OSG",
    # "T3_US_Baylor",
    # "T3_US_Colorado",
    # "T3_US_NotreDame",
    # "T3_US_Rice",
    # "T3_US_UMiss",
    # "T3_US_PuertoRico",
    # "T3_US_Cornell",
    # "T3_US_FIT",
    # "T3_US_FIU",
    # "T3_US_OSU",
    # "T3_US_Rutgers",
    # "T3_US_TAMU",
    # "T3_US_TTU",
    # "T3_US_UCD",
    # "T3_US_UMD",
    # "T3_US_UMiss",
]

TEMPLATE = """
universe                = Vanilla
Requirements            = (HAS_SINGULARITY=?=True)
RequestMemory           = {mem_kb}
RequestCpus             = {n_cpus}
executable              = condor_executable.sh
arguments               = {ceph_user} {cmssw} {scram}
transfer_executable     = True
transfer_input_files    = packages/{sample}.tar.gz
transfer_output_files   = ""
log                     = {cwd}/tasks/{sample}/condor.log
output                  = {cwd}/tasks/{sample}/1e.$(Cluster).$(Process).stdout
error                   = {cwd}/tasks/{sample}/1e.$(Cluster).$(Process).stderr
notification            = Never
should_transfer_files   = YES
when_to_transfer_output = ON_EXIT
x509userproxy           = {x509_proxy}
use_x509userproxy       = True
+DESIRED_Sites          = "{sites}"
+JobBatchName           = "{sample}"
+project_Name           = "cmssurfandturf"
+tag                    = "{tag}"

queue
"""

def make_submit(sample, mem_kb=2048, n_cpus=1, cmssw="CMSSW_10_6_0", scram="slc7_amd64_gcc700",
                sites=GOOD_SITES, tag=""):
    os.makedirs(f"tasks/{sample}", exist_ok=True)
    submit_cmd = TEMPLATE.format(
        sample=sample,
        mem_kb=mem_kb,
        n_cpus=n_cpus,
        ceph_user=os.environ["USER"],
        cmssw=cmssw,
        scram=scram,
        cwd=os.getcwd(),
        x509_proxy=f"/tmp/x509up_u{os.getuid()}",
        sites=" ".join(sites),
        tag=tag
    )
    with open(f"tasks/{sample}/submit.cmd", "w") as f_out:
        f_out.write(submit_cmd)

if __name__ == "__main__":
    make_submit(
        "VBSWH_mkW_Inclusive_4f_LO",
        mem_kb=2048,
        n_cpus=12,
        cmssw="CMSSW_10_6_0",
        scram="slc7_amd64_gcc700",
        sites=["T2_US_Purdue"],
        tag="test"
    )
